# K6 Load Testing Scripts

Нагрузочное тестирование для PR Reviewer Assignment Service.

## Требования

- Установленный k6: https://k6.io/docs/getting-started/installation/
- Запущенный сервис на `http://localhost:8080` (или другой URL через переменную окружения)

## Скрипты

### 1. `load_test_low.js` - Базовая нагрузка (SLI требования)

**Нагрузка:**
- RPS: 5 запросов в секунду
- Длительность: 1 минута
- SLI: 95% запросов < 300ms
- Успешность: 99.9%

**Запуск:**
```bash
k6 run load_test/load_test_low.js
```

### 2. `load_test_medium.js` - Средняя нагрузка

**Нагрузка:**
- RPS: 20 → 50 запросов в секунду (постепенное увеличение)
- Длительность: 1 минута
- SLI: 95% запросов < 500ms
- Успешность: 99%

**Запуск:**
```bash
k6 run load_test/load_test_medium.js
```

### 3. `load_test_high.js` - Высокая нагрузка

**Нагрузка:**
- RPS: 50 → 100 → 200 запросов в секунду (постепенное увеличение)
- Длительность: 1 минута
- SLI: 95% запросов < 1000ms
- Успешность: 95%

**Запуск:**
```bash
k6 run load_test/load_test_high.js
```

### 4. `load_test_stress.js` - Стресс-тест (предельная нагрузка)

**Нагрузка:**
- RPS: 100 → 200 → 300 → 500 запросов в секунду (постепенное увеличение)
- Длительность: 1 минута
- SLI: 95% запросов < 2000ms
- Успешность: 90%

**Запуск:**
```bash
k6 run load_test/load_test_stress.js
```

## Параметры

### Настройка URL сервера

По умолчанию используется `http://localhost:8080`. Для изменения:

```bash
BASE_URL=http://your-server:8080 k6 run load_test/load_test_low.js
```

### Сохранение результатов

Для сохранения результатов в JSON:

```bash
k6 run --out json=results.json load_test/load_test_high.js
```

Для визуализации результатов используйте k6 Cloud или другие инструменты.

## Тестируемые эндпоинты

Все скрипты тестируют следующие эндпоинты:
- POST /team/add
- GET /team/get
- POST /users/setIsActive
- GET /users/getReview
- POST /pullRequest/create
- POST /pullRequest/merge
- POST /pullRequest/reassign
- GET /stats

## Рекомендации по тестированию

1. **Начните с низкой нагрузки** (`load_test_low.js`) - убедитесь, что сервис работает корректно
2. **Постепенно увеличивайте нагрузку** - переходите к medium, затем high
3. **Стресс-тест** (`load_test_stress.js`) - используйте для определения максимальной нагрузки
4. **Мониторинг** - следите за использованием CPU, памяти и соединений с БД во время тестов
5. **База данных** - убедитесь, что PostgreSQL может выдержать нагрузку

## Интерпретация результатов

### Хорошие показатели:
- ✅ Все checks проходят (> 99%)
- ✅ checks rate > 0.99 (99%+ проверок успешны)
- ✅ p(95) latency в пределах thresholds
- ✅ Нет резких скачков latency

**Примечание:** Используется метрика `checks` вместо `http_req_failed`, так как k6 считает все 4xx/5xx статусы ошибками, хотя некоторые из них (404, 409) являются валидными ответами для бизнес-логики API.

### Проблемы:
- ❌ Высокий процент ошибок (> 5%)
- ❌ Latency растет экспоненциально
- ❌ Много timeout'ов
- ❌ Резкое падение производительности при увеличении нагрузки

## Пример вывода

```
✓ POST /team/add status is 201 or 400
✓ GET /team/get status is 200 or 404
...

checks.........................: 99.50% ✓ 19900     ✗ 100
data_received..................: 12 MB  100 kB/s
data_sent......................: 4.5 MB 37 kB/s
http_req_duration..............: avg=120ms   min=15ms   med=95ms   max=850ms   p(95)=450ms
http_reqs......................: 20000   166/s
iteration_duration.............: avg=800ms  min=200ms  med=750ms  max=2000ms
iterations.....................: 2500    20.8/s
vus............................: 200     min=50      max=200
```
